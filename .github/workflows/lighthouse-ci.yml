name: Lighthouse CI

on:
  pull_request:
    branches:
      - fe/dev
      - fe/prod
    paths:
      - "frontend/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  lhci:
    name: Lighthouse CI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build # Webpack â†’ build/ ìƒì„±

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli

      - name: Run Lighthouse CI
        run: |
          lhci autorun \
            --collect.staticDistDir=./build \
            --collect.numberOfRuns=1 \
            --upload.target=filesystem \
            --upload.outputDir=./lhci_reports || echo "Lighthouse CI failed"

      - name: Format Lighthouse Score
        id: format_lighthouse_score
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync("./frontend/lhci_reports/manifest.json"));
            const result = results[0]; // âœ… ì²« ë²ˆì§¸ ê²°ê³¼ë§Œ ì‚¬ìš©

            const details = JSON.parse(fs.readFileSync(result.jsonPath));
            const { audits } = details;
            const summary = result.summary;

            const fmt = (s) => Math.round(s * 100);
            Object.keys(summary).forEach((k) => summary[k] = fmt(summary[k]));
            const icon = (v) => (v >= 90 ? "ğŸŸ¢" : v >= 50 ? "ğŸŸ " : "ğŸ”´");

            const comment = [
              `## âš¡ï¸ Lighthouse Report`,
              `| Category | Score |`,
              `| --- | --- | --- |`,
              `| ${icon(summary.performance)} Performance (ì„±ëŠ¥) | ${summary.performance} |`,
              `| ${icon(summary.accessibility)} Accessibility (ì ‘ê·¼ì„±) | ${summary.accessibility} |`,
              `| ${icon(summary['best-practices'])} Best Practices (ëª¨ë²” ì‚¬ë¡€) | ${summary['best-practices']} |`,
              `| ${icon(summary.seo)} SEO (ê²€ìƒ‰ì—”ì§„ ìµœì í™”) | ${summary.seo} |`,
            ].join("\n");

            const detail = [
              `### ğŸ“Š Performance Details (ì„±ëŠ¥ ì„¸ë¶€ ì§€í‘œ)`,
              `| Metric (ì§€í‘œ)) | Value |`,
              `| --- | --- | --- |`,
              `| ${icon(audits["first-contentful-paint"].score*100)} First Contentful Paint (ìµœì´ˆ ì½˜í…ì¸  í‘œì‹œ) | ${audits["first-contentful-paint"].displayValue} |`,
              `| ${icon(audits["largest-contentful-paint"].score*100)} Largest Contentful Paint (ìµœëŒ€ ì½˜í…ì¸  í‘œì‹œ) | ${audits["largest-contentful-paint"].displayValue} |`,
              `| ${icon(audits["total-blocking-time"].score*100)} Total Blocking Time (ì´ ì°¨ë‹¨ ì‹œê°„) | ${audits["total-blocking-time"].displayValue} |`,
              `| ${icon(audits["cumulative-layout-shift"].score*100)} Cumulative Layout Shift (ëˆ„ì  ë ˆì´ì•„ì›ƒ ì´ë™) | ${audits["cumulative-layout-shift"].displayValue} |`,
              `| ${icon(audits["interactive"].score*100)} Time To Interactive (ìƒí˜¸ì‘ìš© ê°€ëŠ¥ ì‹œê°„) | ${audits["interactive"].displayValue} |`,
            ].join("\n");

            core.setOutput("comments", comment + "\n\n" + detail);

      - name: Comment on PR
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: lighthouse
          message: ${{ steps.format_lighthouse_score.outputs.comments }}
