#!/bin/bash

# ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ
set -e

# ====================================================================
#                     MySQL ì ‘ì† ì •ë³´ ì„¤ì •
# ====================================================================
read -p "ì ‘ì†í•  MySQL í˜¸ìŠ¤íŠ¸ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”: " DB_HOST

if [ -z "$DB_HOST" ]; then
    echo "ğŸš¨ ì˜¤ë¥˜: í˜¸ìŠ¤íŠ¸ ì£¼ì†ŒëŠ” ë°˜ë“œì‹œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."
    exit 1
fi

read -p "MySQL í¬íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ê°’: 3306): " DB_PORT_INPUT
DB_PORT="${DB_PORT_INPUT:-3306}" # ì…ë ¥ì´ ì—†ìœ¼ë©´ 3306ì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ì‚¬ìš©

DB_USER="root"
DB_NAME="estimedb"
COMBINED_SQL_FILE="all_in_one.sql"

# ====================================================================
#         ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ í•­ìƒ ì‹¤í–‰ë  ë§ˆë¬´ë¦¬ í•¨ìˆ˜
# ====================================================================
cleanup() {
    sleep 1
    echo ">> ë§ˆë¬´ë¦¬ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
    if [ -f "$COMBINED_SQL_FILE" ]; then
        rm "$COMBINED_SQL_FILE"
        echo "-> ì„ì‹œ í†µí•© SQL íŒŒì¼($COMBINED_SQL_FILE)ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤."
    fi
    echo ">> ë§ˆë¬´ë¦¬ ì‘ì—… ì™„ë£Œ"
}

# ìŠ¤í¬ë¦½íŠ¸ê°€ ì¢…ë£Œë  ë•Œ cleanup í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ë„ë¡ ì„¤ì •
trap cleanup EXIT

# ====================================================================
#      SQL íŒŒì¼ë“¤ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ íŒŒì¼ë¡œ í†µí•©
# ====================================================================
echo ">> ëª¨ë“  SQL íŒŒì¼ì„ í•˜ë‚˜ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ í†µí•©í•˜ëŠ” ì¤‘..."
echo "START TRANSACTION;" > "$COMBINED_SQL_FILE"

cat test_room.sql >> "$COMBINED_SQL_FILE"
cat test_participant.sql >> "$COMBINED_SQL_FILE"
cat test_room_available_date_slot.sql >> "$COMBINED_SQL_FILE"
cat test_room_available_time_slot.sql >> "$COMBINED_SQL_FILE"
cat test_vote.sql >> "$COMBINED_SQL_FILE"

echo "COMMIT;" >> "$COMBINED_SQL_FILE"

echo ">> í†µí•© íŒŒì¼ ìƒì„± ì™„ë£Œ: $COMBINED_SQL_FILE"

# ====================================================================
#               ì¿¼ë¦¬ í†µí•© íŒŒì¼ ì‹¤í–‰
# ====================================================================
echo ">> í…ŒìŠ¤íŠ¸ìš© ë°ì´í„° ì‚½ì…ì„ ì‹œì‘í•©ë‹ˆë‹¤. (ëŒ€ìƒ: $DB_HOST:$DB_PORT)"

mysql --default-character-set=utf8mb4 -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p "$DB_NAME" < "$COMBINED_SQL_FILE"

echo "âœ… í…ŒìŠ¤íŠ¸ ë°ì´í„° ì‚½ì… ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
